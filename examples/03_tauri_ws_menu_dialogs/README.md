# Tauri + WebSocket

This example leverage tauri for serving/bundling HTML/CSS/JS and leverage trame just for its WebSocket connection. Such setup provide a more secured setup by making more complicated for someone to connect to the application using a browser.

Then on top of the basic we start leveraging some capability of tauri directly such as native menus and dialogs.

## Tauri project

Since Tauri is written in Rust, let's get setup with its dev environment.

```bash
# Install rust
curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf | sh

# Enable rust within shell
. "$HOME/.cargo/env"

# Install tauri-cli
cargo install tauri-cli
```

Then, the infrastructure (./src-tauri) was generated by running the following commands. 

__Caution__: No need to redo it since we committed the generated structure to the repo.

```bash
$ cargo tauri init

✔ What is your app name? · Cone
✔ What should the window title be? · Cone
✔ Where are your web assets (HTML/CSS/JS) located, relative to the "<current dir>/src-tauri/tauri.conf.json" file that will be created? · ./www
✔ What is the url of your dev server? · ./www
✔ What is your frontend dev command? · 
✔ What is your frontend build command? · 
```

From the default content, we edited the following set of files:

- `./src-tauri/src/main.rs`: Generic main application designed for trame which can remain the same regardless of your application but where the menus are getting declared.
- `./src-tauri/sidecar/*`: OS specific launcher for a trame server. The mac and linux version are just plain bash scripts while the Windows one is a simple compiled C++ application that forward the args to the actual trame python executable generated by PyInstaller. Those can be re-used as-is for any trame app.
- `./src-tauri/www/*`: Basic content for splashscreen and temporary main window content before we apply a redirect. Those are static and could be adjusted by adding your own image as splashscreen.
- `./src-tauri/icons`: Remove default ones (`rm -rf ./src-tauri/icons`)
- `./src-tauri/Cargo.toml`: Added new dependencies and required feature.
- `./src-tauri/tauri.conf.json`: Edited the following sections
    - tauri > allowlist: + shell/sidecar + dialog
    - tauri > bundle > externalBin : ["sidecar/trame"]
    - tauri > bundle > identifier  : "trame.cone"
    - tauri > bundle > resources   : ["server"] # pyinstaller generated app
    - tauri > bundle > targets     : ["appimage", "nsis", "msi", "app", "dmg"]
    - tauri > security > csp       : "default-src 'self' 'unsafe-inline' ws: localhost; script-src 'unsafe-eval' 'self';"
    - tauri > windows              : main-not-visible + splashscreen


## Trame example

We use a simple cone example since it does not have any complex python dependency.


```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install trame trame-vtk trame-vuetify trame-tauri pyinstaller
```

Build bundle for tauri inside `./src-tauri/server/*` while skipping the web content.

```bash
python -m PyInstaller \
    --clean --noconfirm \
    --distpath src-tauri \
    --name server \
    --hidden-import pkgutil \
    cone.py
```

Generate webcontent for tauri to bundle

```bash
python -m trame.tools.www --output ./src-tauri/www
```

## Tauri bundle

In order to build and bundle the application, just run

```bash
# Generate icon for application using ./app-icon.png
cargo tauri icon

# Generate application
cargo tauri build

# Run generated application
open ./src-tauri/target/release/bundle/macos/Cone.app
```
